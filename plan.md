# 네이버 카페 스크래퍼 프로젝트 계획

## 프로젝트 개요

네이버 카페에서 게시글, 댓글, 이미지를 수집하여 CSV 파일로 저장하는 자동화 도구입니다.

## 아키텍처

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   웹 UI         │    │   FastAPI       │    │   Playwright    │
│   (사용자)      │◄──►│   (API 서버)    │◄──►│   (브라우저)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │   CSV 저장      │
                       │   (결과물)      │
                       └─────────────────┘
```

## 데이터 스키마

### 게시글 정보
- `cafe_id`: 카페 ID
- `article_id`: 게시글 ID  
- `title`: 제목
- `author_nickname`: 작성자 닉네임
- `content_text`: 텍스트 내용
- `content_html`: HTML 내용
- `date`: 작성일
- `url`: 게시글 URL
- `images_base64`: 이미지 (Base64 인코딩)
- `comments`: 댓글 목록
- `scraped_at`: 스크래핑 시간

### 댓글 정보
- `author_nickname`: 댓글 작성자
- `content`: 댓글 내용
- `date`: 댓글 작성일
- `like_count`: 좋아요 수

## 핵심 기능

### 1. 로그인 시스템
- 수동 로그인 + 쿠키 저장
- 세션 유지 및 자동 갱신
- 로그인 상태 확인

### 2. 게시글 스크래핑
- 게시글 상세 정보 수집 (제목, 내용, 작성자, 날짜)
- 이미지 수집 및 Base64 인코딩
- 댓글 수집 및 필터링
- 페이지네이션 지원

### 3. 배치 처리
- 여러 게시글 동시 처리
- 진행률 표시
- 에러 처리 및 재시도

### 4. 데이터 저장
- CSV 파일로 저장
- 날짜별 폴더 구조
- 이미지 Base64 인코딩

## 개발 단계

### Phase 1: 기본 구조 및 로그인 시스템 ✅
- [x] 프로젝트 구조 설정
- [x] FastAPI 서버 구현
- [x] Playwright 기반 브라우저 자동화
- [x] 수동 로그인 + 쿠키 저장 구현
- [x] CSV 출력 시스템
- [x] 기본 웹 UI

### Phase 2: 핵심 스크래핑 기능 ✅
- [x] 게시글 상세 정보 수집 (제목, 내용, 작성자, 날짜)
- [x] 이미지 수집 및 Base64 인코딩
- [x] 댓글 수집 및 필터링
- [x] 게시판 스크래핑 (페이지네이션 지원)
- [x] 배치 처리 (여러 게시글 동시 처리)
- [x] DOM 셀렉터 개선
- [x] 에러 처리 및 재시도 로직
- [x] 새로운 API 엔드포인트 구현
- [x] test_board_scraping.py 테스트 스크립트 작성

### Phase 3: 안정화 및 최적화 ❌ **블로킹**
- [x] 성능 최적화 (동시 처리, 메모리 관리)
- [x] 안티봇 대응 (User-Agent 로테이션, 지연 시간)
- [x] 웹 UI 구현 (사용자 친화적 인터페이스)
- [x] 로깅 및 모니터링 시스템
- [x] 시스템 상태 모니터링
- [x] 배치 크롤링 UI (키워드 검색, 작성자 필터링)
- [x] Chrome DevTools 404 에러 해결
- [x] Favicon 404 에러 해결
- [x] 로그 파일 저장 기능

## 현재 상태 (Current Status) - 2025-09-26 업데이트

- **Phase 1**: ✅ 완료 (기본 구조 및 로그인)
- **Phase 2**: ✅ 완료 (핵심 스크래핑 기능)  
- **Phase 3**: ⚠️ **부분 완료** (안정화 진행 중)

## 🔄 **현재 진행 상황 (2025-09-26)**

### ✅ 해결된 문제들

#### 1. Windows Playwright 호환성 문제 → **해결됨**
- **이전 에러**: `NotImplementedError` in `asyncio.subprocess`
- **해결 방법**: Playwright → Selenium WebDriver 전환
- **현재 상태**: ✅ 정상 작동

#### 2. Mock 모드 문제 → **해결됨**
- **이전 에러**: `'str' object is not callable`
- **해결 방법**: 실제 Selenium 구현으로 대체
- **현재 상태**: ✅ 정상 작동

#### 3. 로그인 세션 불안정 문제 → **해결됨**
- **이전 에러**: `invalid session id`, 브라우저 세션 끊김
- **해결 방법**: 
  - 중복 `ensure_logged_in()` 호출 제거
  - 쿠키 도메인 처리 개선 (`.naver.com` 통일)
  - 브라우저 세션 유효성 검사 강화
- **현재 상태**: ✅ 정상 작동

#### 4. 파일 권한 오류 → **해결됨**
- **이전 에러**: `[Errno 13] Permission denied` (CSV 파일 저장)
- **해결 방법**: 고유 파일명 생성 시스템 구현
- **현재 상태**: ✅ 정상 작동

### ⚠️ **현재 진행 중인 문제들**

#### 1. 제목 추출 실패 → **진행 중**
- **문제**: 게시글 제목이 "제목을 찾을 수 없음" 또는 카페 제목으로 표시
- **원인**: 네이버 카페 HTML 구조 변경으로 인한 셀렉터 불일치
- **시도한 해결책**:
  - 제목 셀렉터 다중 업데이트 (카페 제목 제외)
  - 디버깅 시스템 강화
  - 완전히 새로운 접근 방식 적용
- **현재 상태**: 🔄 **진행 중** (여전히 실패)

#### 2. 내용/작성자 추출 실패 → **진행 중**
- **문제**: 게시글 내용, 작성자, 댓글 추출 실패
- **원인**: 네이버 카페 최신 HTML 구조 변경
- **시도한 해결책**:
  - CSS 셀렉터 대폭 업데이트
  - 디버깅 시스템 추가
- **현재 상태**: 🔄 **진행 중**

#### 3. 서버 오류 → **진행 중**
- **문제**: 500 Internal Server Error 발생
- **원인**: 스크래핑 과정에서 예외 발생
- **현재 상태**: 🔄 **진행 중**

### 📊 **최근 테스트 결과 (2025-09-26)**

#### 성공한 부분:
- ✅ 게시판 목록 조회 (71개 게시판)
- ✅ 키워드 필터링 (건선, 아토피 검색)
- ✅ 게시판 필터링 (가입인사 게시판만 선택)
- ✅ 게시글 링크 수집 (117개 게시글 발견)
- ✅ 파일명 중복 방지 시스템

#### 실패한 부분:
- ❌ 제목 추출 (모두 "제목을 찾을 수 없음")
- ❌ 내용 추출 (모두 "내용을 찾을 수 없음")
- ❌ 작성자 추출 (모두 "작성자를 찾을 수 없음")
- ❌ 댓글 추출 (모두 "댓글을 찾을 수 없음")

### 🔍 **디버깅 결과**

```
🔍 발견된 h 태그들: ['비타민D자외선요법 - 아토피,건선,백반증,두드러기,습진,알러지']
🔍 발견된 title 클래스들: ['Header_title_img__pSNEK']
🔍 발견된 클래스들: ['gnb_my_content', 'input_text', 'Layout_content__pUOz1']
```

**분석**: 
- H1 태그는 카페 제목만 발견됨
- `Header_title_img__pSNEK` 클래스는 카페 헤더 제목
- 실제 게시글 제목을 찾는 셀렉터가 필요

## 🚀 다음 세션에서 할 일 (2025-09-26 업데이트)

### 🔥 **최우선순위: 새로운 세션 시작**

#### 1. 깨끗한 환경에서 재시작
- **현재 문제**: 브라우저 세션 불안정, 제목 추출 실패
- **해결 방법**: 새로운 세션으로 완전 초기화
- **단계**:
  1. 모든 프로세스 종료 (`taskkill /f /im python.exe`, `taskkill /f /im chrome.exe`)
  2. 세션 데이터 정리 (선택사항)
  3. 서버 재시작
  4. 새로운 로그인 세션 시작

#### 2. 네이버 카페 HTML 구조 재분석
- **목표**: 실제 게시글 제목 셀렉터 찾기
- **방법**: 
  - 브라우저 개발자 도구로 실제 HTML 구조 확인
  - 게시글 제목이 있는 정확한 셀렉터 식별
  - 셀렉터 업데이트 및 테스트

#### 3. 단계적 테스트 접근
- **1단계**: 단일 게시글 스크래핑 테스트
- **2단계**: 제목 추출 성공 확인
- **3단계**: 내용/작성자/댓글 추출 테스트
- **4단계**: 배치 크롤링 테스트

### 📋 **새로운 세션 체크리스트**

#### 환경 정리:
- [ ] 모든 Python 프로세스 종료
- [ ] 모든 Chrome 프로세스 종료
- [ ] 서버 재시작
- [ ] 웹 UI 접속 확인

#### 테스트 순서:
- [ ] 로그인 세션 안정성 확인
- [ ] 게시판 목록 조회 테스트
- [ ] 단일 게시글 스크래핑 테스트
- [ ] 제목 추출 성공 확인
- [ ] 내용/작성자/댓글 추출 테스트
- [ ] 배치 크롤링 테스트

### 🎯 **예상 해결 방향**

#### 1. HTML 구조 분석
- 네이버 카페 최신 구조 파악
- 게시글 제목이 있는 정확한 셀렉터 식별
- 카페 제목과 게시글 제목 구분

#### 2. 셀렉터 전략 변경
- 현재: 다중 셀렉터 시도
- 개선: 정확한 셀렉터 1개로 집중
- 디버깅: 실제 HTML 구조 기반 셀렉터 개발

#### 3. 안정성 개선
- 브라우저 세션 유지 강화
- 에러 처리 개선
- 재시도 로직 최적화

## 🎯 해결된 방향

1. ✅ **Playwright 포기**: Windows 호환성 문제로 인해 Selenium 사용
2. ✅ **Selenium 구현**: 더 안정적인 브라우저 자동화
3. ✅ **자동 로그인 감지**: 사용자 경험 개선
4. ✅ **Chrome 옵션 최적화**: 에러 메시지 감소
5. ✅ **로그인 세션 안정화**: 중복 호출 제거, 쿠키 도메인 처리
6. ✅ **파일 권한 오류 해결**: 고유 파일명 생성 시스템

## 📝 **새로운 세션 시작 시 체크리스트 (2025-09-26 업데이트)**

### ✅ **해결된 문제들**
1. **파일 통합 문제**: ✅ 해결됨
   - 배치 스크래핑 시 하나의 파일로 통합
   - `batch_articles_{timestamp}.csv` 형식으로 저장
   - `app/utils/csv_writer.py`에 `batch_id` 매개변수 추가

2. **서버 실행 문제**: ✅ 해결됨
   - 포트 8001에서 정상 실행
   - `python -m app.main` 명령어로 실행

3. **게시판 스크래핑**: ✅ 완벽 작동
   - 71개 게시판 정상 수집
   - 117개 게시글 발견
   - 키워드 필터링 완벽 작동

### ❌ **핵심 문제: 데이터 추출 실패**

#### **현재 상황**
- **제목**: "제목을 찾을 수 없음" (모든 셀렉터 실패)
- **내용**: "내용을 찾을 수 없음" (모든 셀렉터 실패)
- **작성자**: "작성자를 찾을 수 없음" (모든 셀렉터 실패)
- **댓글**: "댓글을 찾을 수 없음" (모든 셀렉터 실패)

#### **근본 원인 분석**
1. **네이버 카페 HTML 구조 완전 변경**: 기존 셀렉터 모두 실패
2. **JavaScript 동적 로딩**: 실제 게시글 내용이 JS로 나중에 로딩
3. **카페 제목과 게시글 제목 구분 실패**: h1 태그는 카페 제목만 존재
4. **se- 관련 클래스 없음**: 네이버 에디터 구조 변경

#### **디버깅 결과**
```
🔍 발견된 h 태그들: ['비타민D자외선요법 - 아토피,건선,백반증,두드러기,습진,알러지']
🔍 발견된 title 클래스들: ['Header_title_img__pSNEK']
❌ 게시글 본문 영역을 찾을 수 없음
✅ 전체 h 태그 발견: 1개 (카페 제목만)
```

### 🚀 **새로운 세션에서 해야 할 일**

#### **1. 환경 정리**
- [ ] 모든 Python 프로세스 종료: `taskkill /f /im python.exe`
- [ ] 모든 Chrome 프로세스 종료: `taskkill /f /im chrome.exe`
- [ ] 서버 재시작: `python -m app.main`
- [ ] 웹 UI 접속: `http://127.0.0.1:8001`

#### **2. 근본적 해결 방안**

##### **방안 1: JavaScript 로딩 대기 강화**
```python
# app/scraper/naver.py에서 _extract_article_data 함수 수정
# WebDriverWait를 사용하여 JavaScript 로딩 대기
wait = WebDriverWait(self.driver, 30)
element = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, selector)))
```

##### **방안 2: 네트워크 요청 분석**
- 네이버 카페 API 엔드포인트 찾기
- JSON 응답으로 데이터 추출
- JavaScript 없이 직접 API 호출

##### **방안 3: 완전히 새로운 셀렉터**
- 실제 브라우저에서 F12로 HTML 구조 확인
- 게시글 제목/내용/작성자의 정확한 셀렉터 찾기
- 카페 제목과 게시글 제목 구분 로직 개선

#### **3. 우선순위 작업**

1. **최우선**: 실제 HTML 구조 파악
   - 브라우저에서 F12로 게시글 페이지 구조 확인
   - 게시글 제목/내용/작성자의 정확한 셀렉터 식별
   - `app/scraper/naver.py`의 셀렉터 업데이트

2. **차선책**: JavaScript 로딩 대기 강화
   - `WebDriverWait` 사용하여 동적 로딩 대기
   - `time.sleep()` 대신 `EC.presence_of_element_located()` 사용

3. **최후**: API 기반 접근
   - 네이버 카페 API 엔드포인트 찾기
   - JavaScript 없이 직접 데이터 추출

#### **4. 테스트 순서**
- [ ] 로그인 세션 안정성 확인
- [ ] 단일 게시글 스크래핑 테스트 (새로운 셀렉터 적용)
- [ ] 제목 추출 성공 확인
- [ ] 내용/작성자/댓글 추출 테스트
- [ ] 배치 크롤링 테스트

#### **5. 핵심 목표**
- [ ] **제목 추출 성공**: "제목을 찾을 수 없음" → 실제 게시글 제목
- [ ] **내용 추출 성공**: "내용을 찾을 수 없음" → 실제 게시글 내용
- [ ] **작성자 추출 성공**: "작성자를 찾을 수 없음" → 실제 작성자
- [ ] **댓글 추출 성공**: "댓글을 찾을 수 없음" → 실제 댓글

### 📊 **현재 성공률**
- **게시판 수집**: 100% 성공 ✅
- **키워드 필터링**: 100% 성공 ✅
- **파일 통합**: 100% 성공 ✅
- **데이터 추출**: 0% 성공 ❌
- **전체 시스템**: 75% 성공 (데이터 추출만 해결하면 완성)

## 기술 스택

- **Backend**: FastAPI, Python 3.13
- **Browser Automation**: ~~Playwright~~ → **Selenium** (권장)
- **Data Processing**: pandas, BeautifulSoup
- **Frontend**: HTML, CSS, JavaScript
- **Storage**: CSV files, JSON cookies

## 파일 구조

```
CafeScraper/
├── app/
│   ├── main.py              # FastAPI 서버
│   ├── scraper/
│   │   └── naver.py         # 스크래핑 로직
│   ├── utils/
│   │   ├── csv_writer.py   # CSV 저장
│   │   ├── logger.py       # 로깅
│   │   └── monitor.py       # 모니터링
│   └── static/
│       └── index.html       # 웹 UI
├── sessions/                # 쿠키 저장
├── outputs/                 # CSV 출력
├── snapshots/               # 스크린샷
├── server.log               # 서버 로그
├── requirements.txt
├── plan.md
└── CURRENT_STATUS.md
```